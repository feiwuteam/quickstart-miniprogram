{"remainingRequest":"/home/fupeng/Workspace/wechat/quickstart-miniprogram/node_modules/thread-loader/dist/cjs.js??ref--2-1!/home/fupeng/Workspace/wechat/quickstart-miniprogram/node_modules/ts-loader/index.js??ref--2-2!/home/fupeng/Workspace/wechat/quickstart-miniprogram/src/services/http.ts","dependencies":[{"path":"/home/fupeng/Workspace/wechat/quickstart-miniprogram/src/services/http.ts","mtime":1539844294762},{"path":"/home/fupeng/Workspace/wechat/quickstart-miniprogram/node_modules/cache-loader/dist/cjs.js","mtime":1537176859979},{"path":"/home/fupeng/Workspace/wechat/quickstart-miniprogram/node_modules/thread-loader/dist/cjs.js","mtime":1537176860533},{"path":"/home/fupeng/Workspace/wechat/quickstart-miniprogram/node_modules/ts-loader/index.js","mtime":1535545777399}],"contextDependencies":[],"result":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar config_1 = require(\"../config\");\nvar api_1 = require(\"../config/api\");\nvar utils_1 = require(\"../utils\");\nvar wxApi_1 = require(\"../utils/wxApi\");\nvar reLoginTimes = 1;\n// requestID\nfunction generateRequestID() {\n    var num = 0;\n    var rando = function (m) {\n        var num = '';\n        for (var i = 0; i < m; i++) {\n            var val = parseInt((Math.random() * 10).toString(), 10);\n            if (i === 0 && val === 0) {\n                i--;\n                continue;\n            }\n            num += val;\n        }\n        return parseInt(num, 10);\n    };\n    if (!getApp().request_id) {\n        num = rando(8);\n        getApp().request_id = num;\n    }\n    else {\n        getApp().request_id++;\n        num = getApp().request_id;\n    }\n    return num.toString();\n}\nexports.generateRequestID = generateRequestID;\nvar HttpService = /** @class */ (function () {\n    function HttpService() {\n    }\n    HttpService.getUrl = function (uri) {\n        var BASE_API = config_1.default.APP.config.BASE_API;\n        if (uri.match(/^http/)) {\n            return uri;\n        }\n        return uri.indexOf('/') === 0\n            ? BASE_API + uri\n            : BASE_API + '/' + uri;\n    };\n    HttpService._parseRequestOptions = function (req, isAuth) {\n        return __awaiter(this, void 0, Promise, function () {\n            var _a, pin_appid, corp_id, _b, pin_uid, token;\n            return __generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        _a = wx.getExtConfigSync(), pin_appid = _a.pin_appid, corp_id = _a.corp_id;\n                        if (!isAuth) return [3 /*break*/, 2];\n                        return [4 /*yield*/, getApp().dispatch('getToken')];\n                    case 1:\n                        _b = _c.sent(), pin_uid = _b.pin_uid, token = _b.token;\n                        if (!req.header) {\n                            req.header = {};\n                        }\n                        req.url = utils_1.strFormat(req.url, { pin_uid: pin_uid });\n                        Object.assign(req.header, { 'X-Pin-Authorization': token, 'X-Pin-CorpID': corp_id });\n                        _c.label = 2;\n                    case 2:\n                        req.url = utils_1.strFormat(req.url, { pin_appid: pin_appid });\n                        return [2 /*return*/, req];\n                }\n            });\n        });\n    };\n    HttpService._parseResponse = function (res) {\n        // hack\n        wx.hideLoading();\n        return [res.data, res.header];\n    };\n    // currently, post or get method both go into this function\n    HttpService.prototype.jsonRequest = function (data, config) {\n        return this.preRequest(data, config);\n    };\n    HttpService.prototype.fileUpload = function (opt) {\n        return new Promise(function (resolve, reject) {\n            if (opt.url.indexOf('https://') < 0) {\n                opt.url = api_1.file.upload.url + opt.url;\n            }\n            if (!opt.formData) {\n                opt.formData = {\n                    app_id: config_1.default.APP.config.APP_ID,\n                    request_id: generateRequestID()\n                };\n            }\n            opt.name = api_1.file.upload.key;\n            wx.uploadFile(Object.assign(opt, {\n                success: function (data) {\n                    if (data.statusCode === 200) {\n                        var result = JSON.parse(data.data);\n                        // const path = file.upload.prefix + result.uuid;\n                        console.warn('upload success-->', result);\n                        resolve.apply(void 0, [result, data.header]);\n                    }\n                    reject(data.errMsg);\n                },\n                fail: function (err) {\n                    reject(err);\n                }\n            }));\n        });\n    };\n    // [review] note: 目前只考虑多并发中有且仅有一个锁 即不兼容并发中多个 lock 为 true 的情况\n    HttpService.prototype.preRequest = function (req, config) {\n        return __awaiter(this, void 0, Promise, function () {\n            var _a, hasLoading, _b, isLock, error_1;\n            return __generator(this, function (_c) {\n                switch (_c.label) {\n                    case 0:\n                        _a = config.hasLoading, hasLoading = _a === void 0 ? false : _a, _b = config.isLock, isLock = _b === void 0 ? false : _b;\n                        // detect current network\n                        if (!getApp().state.config.networkStatus.isConnected) {\n                            wxApi_1.showToast({\n                                title: '网络不见啦!',\n                                icon: 'none',\n                                duration: 2000\n                            });\n                            return [2 /*return*/];\n                        }\n                        if (hasLoading) {\n                            wxApi_1.showLoading({ title: '加载中' });\n                        }\n                        if (!(getApp().requestLock.status && !isLock)) return [3 /*break*/, 4];\n                        console.warn('Ohh, we are waiting for some request finishing first.');\n                        _c.label = 1;\n                    case 1:\n                        _c.trys.push([1, 3, , 4]);\n                        return [4 /*yield*/, getApp().requestLock.request];\n                    case 2:\n                        _c.sent();\n                        console.warn('Wow, getApp().requestLock.request success.');\n                        return [3 /*break*/, 4];\n                    case 3:\n                        error_1 = _c.sent();\n                        // if getApp().requestLock.request failed, the following requests should not be executed\n                        console.warn('Oops, getApp().requestLock.request failed.');\n                        return [2 /*return*/];\n                    case 4: \n                    // lock status === false\n                    // lock status === true && isLock == true\n                    return [2 /*return*/, this.request(req, config)];\n                }\n            });\n        });\n    };\n    // todo related params\n    HttpService.prototype.request = function (req, config) {\n        return __awaiter(this, void 0, Promise, function () {\n            var _a, isAuth;\n            var _this = this;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        _a = config.isAuth, isAuth = _a === void 0 ? true : _a;\n                        return [4 /*yield*/, HttpService._parseRequestOptions(req, isAuth)];\n                    case 1:\n                        req = _b.sent();\n                        console.warn('request start, config: ', config, req);\n                        return [2 /*return*/, new Promise(function (resolve, reject) {\n                                req.url = HttpService.getUrl(req.url);\n                                wx.Promise.request(req).then(function (res) { return __awaiter(_this, void 0, void 0, function () {\n                                    var statusCode, data, _a, error_2;\n                                    return __generator(this, function (_b) {\n                                        switch (_b.label) {\n                                            case 0:\n                                                statusCode = res.statusCode, data = res.data;\n                                                if (!(statusCode >= 200 && statusCode <= 300)) return [3 /*break*/, 1];\n                                                return [2 /*return*/, resolve.apply(void 0, HttpService._parseResponse(res))];\n                                            case 1:\n                                                if (!(statusCode === 401 && reLoginTimes)) return [3 /*break*/, 8];\n                                                reLoginTimes = 0;\n                                                _b.label = 2;\n                                            case 2:\n                                                _b.trys.push([2, 6, , 7]);\n                                                return [4 /*yield*/, getApp().dispatch('login')];\n                                            case 3:\n                                                _b.sent();\n                                                return [4 /*yield*/, HttpService._parseRequestOptions(req, isAuth)];\n                                            case 4:\n                                                req = _b.sent();\n                                                reLoginTimes = 1;\n                                                _a = resolve;\n                                                return [4 /*yield*/, this.request(req, config)];\n                                            case 5: return [2 /*return*/, _a.apply(void 0, [_b.sent()])];\n                                            case 6:\n                                                error_2 = _b.sent();\n                                                return [2 /*return*/, reject.apply(void 0, HttpService._parseResponse(res))];\n                                            case 7: return [3 /*break*/, 9];\n                                            case 8: return [2 /*return*/, reject.apply(void 0, HttpService._parseResponse(res))];\n                                            case 9: return [2 /*return*/];\n                                        }\n                                    });\n                                }); }).catch(function (err) {\n                                    reject.apply(void 0, HttpService._parseResponse(err));\n                                });\n                            })];\n                }\n            });\n        });\n    };\n    return HttpService;\n}());\nexports.HttpService = HttpService;\n",{"version":3,"file":"/home/fupeng/Workspace/wechat/quickstart-miniprogram/src/services/http.ts","sourceRoot":"","sources":["/home/fupeng/Workspace/wechat/quickstart-miniprogram/src/services/http.ts"],"names":[],"mappings":"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","sourcesContent":["import Conf from '../config';\nimport { file } from '../config/api';\nimport { strFormat } from '../utils';\nimport { showLoading, showToast } from '../utils/wxApi';\n\nlet reLoginTimes = 1;\n\nexport interface IRequestParams {\n    method: string;\n    url: string;\n    data?: object;\n    params?: object;\n    header?: object;\n}\n\nexport interface IRequestExtraConfig {\n    isAuth: boolean;\n    isLock: boolean;\n    hasLoading: boolean;\n    [key: string]: any;\n}\n\nexport interface IUploadFile {\n    url: string;\n    filePath: string;\n    formData?: object;\n    header?: object;\n}\n\nexport interface IResponse {\n    statusCode: number;\n    data: any;\n    errMsg: string;\n    header: any;\n}\n\n// requestID\nexport function generateRequestID(): string {\n    let num: number = 0;\n    const rando = (m: number): number => {\n        let num = '';\n        for (let i = 0; i < m; i++) {\n            const val = parseInt((Math.random() * 10).toString(), 10);\n            if (i === 0 && val === 0) {\n                i--;\n                continue;\n            }\n            num += val;\n        }\n        return parseInt(num, 10);\n    };\n    if (!getApp().request_id) {\n        num = rando(8);\n        getApp().request_id = num;\n    } else {\n        getApp().request_id++;\n        num = getApp().request_id;\n    }\n    return num.toString();\n}\n\nexport class HttpService {\n\n    static getUrl(uri: string): string {\n        const { BASE_API } = Conf.APP.config;\n\n        if (uri.match(/^http/)) {\n            return uri;\n        }\n\n        return uri.indexOf('/') === 0\n            ? BASE_API + uri\n            : BASE_API + '/' + uri;\n    }\n\n    private static async _parseRequestOptions(req: WXNetAPIRequestObj, isAuth: boolean): Promise<WXNetAPIRequestObj> {\n        const { pin_appid, corp_id } = wx.getExtConfigSync();\n        if (isAuth) {\n            const { pin_uid, token } = await getApp().dispatch('getToken');\n            if (!req.header) {\n                req.header = {};\n            }\n            req.url = strFormat(req.url, { pin_uid });\n            Object.assign(req.header, { 'X-Pin-Authorization': token, 'X-Pin-CorpID': corp_id });\n        }\n        req.url = strFormat(req.url, { pin_appid });\n        return req;\n    }\n\n    private static _parseResponse(res: IResponse): any[] {\n        // hack\n        wx.hideLoading();\n        return [res.data, res.header];\n    }\n\n    // currently, post or get method both go into this function\n    jsonRequest(data: IRequestParams, config: IRequestExtraConfig): Promise<any> {\n        return this.preRequest(data, config);\n    }\n\n    fileUpload(opt: IUploadFile): Promise<any> {\n        return new Promise((resolve, reject) => {\n            if (opt.url.indexOf('https://') < 0) {\n                opt.url = file.upload.url + opt.url;\n            }\n            if (!opt.formData) {\n                opt.formData = {\n                    app_id: Conf.APP.config.APP_ID,\n                    request_id: generateRequestID()\n                };\n            }\n            (opt as WXNetAPIUploadFileObj).name = file.upload.key;\n            wx.uploadFile(Object.assign(opt, {\n                success: (data: IResponse) => {\n                    if (data.statusCode === 200) {\n                        const result = JSON.parse(data.data);\n                        // const path = file.upload.prefix + result.uuid;\n                        console.warn('upload success-->', result);\n                        resolve(...[result, data.header]);\n                    }\n                    reject(data.errMsg);\n                },\n                fail: (err: IResponse) => {\n                    reject(err);\n                }\n            }));\n        });\n    }\n\n    // [review] note: 目前只考虑多并发中有且仅有一个锁 即不兼容并发中多个 lock 为 true 的情况\n    async preRequest(req: WXNetAPIRequestObj, config: IRequestExtraConfig): Promise<any> {\n        const { hasLoading = false, isLock = false } = config;\n\n        // detect current network\n        if (!getApp().state.config.networkStatus.isConnected) {\n            showToast({\n                title: '网络不见啦!',\n                icon: 'none',\n                duration: 2000\n            });\n            return;\n        }\n\n        if (hasLoading) {\n            showLoading({ title: '加载中' });\n        }\n\n        // detect lock status\n        if (getApp().requestLock.status && !isLock) {\n            console.warn('Ohh, we are waiting for some request finishing first.');\n\n            try {\n                await getApp().requestLock.request;\n                console.warn('Wow, getApp().requestLock.request success.');\n            } catch (error) {\n                // if getApp().requestLock.request failed, the following requests should not be executed\n                console.warn('Oops, getApp().requestLock.request failed.');\n                return;\n            }\n        }\n\n        // lock status === false\n        // lock status === true && isLock == true\n        return this.request(req, config);\n    }\n\n    // todo related params\n    async request(req: WXNetAPIRequestObj, config: IRequestExtraConfig): Promise<any> {\n        const { isAuth = true } = config;\n        req = await HttpService._parseRequestOptions(req as WXNetAPIRequestObj, isAuth);\n        console.warn('request start, config: ', config, req);\n        return new Promise((resolve, reject) => {\n            req.url = HttpService.getUrl(req.url);\n            wx.Promise.request(req).then(async (res: IResponse) => {\n                const { statusCode, data } = res;\n\n                if (statusCode >= 200 && statusCode <= 300) {\n                    return resolve(...HttpService._parseResponse(res));\n                } else if (statusCode === 401 && reLoginTimes) {\n                    reLoginTimes = 0;\n                    try {\n                        await getApp().dispatch('login');\n                        req = await HttpService._parseRequestOptions(req as WXNetAPIRequestObj, isAuth);\n                        reLoginTimes = 1;\n                        return resolve(await this.request(req, config));\n                    } catch (error) {\n                        return reject(...HttpService._parseResponse(res));\n                    }\n                } else {\n                    return reject(...HttpService._parseResponse(res));\n                }\n            }).catch((err: any) => {\n                reject(...HttpService._parseResponse(err));\n            });\n        });\n    }\n}\n"]}]}